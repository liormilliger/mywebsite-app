<h3>Jenkinsfile (Declarative Pipeline)</h3>

<div class="snippet-intro">
    <p>
        <strong>Why Jenkins?</strong> As a leading open-source automation server, Jenkins provides hundreds of plugins to support building, deploying, and automating any project. It's incredibly flexible and offers a mature, battle-tested platform for creating powerful CI/CD pipelines.
    </p>
</div>

<pre><code>pipeline {
    agent any
</code></pre>

<div class="code-accordion">
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">environment { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>    environment {
        AWS_REGION     = 'REGION'
        ECR_REGISTRY   = 'MY_ECR_REGISTRY'
        ECR_REPOSITORY = 'MY_REPO'
        IMAGE_FILE_NAME = 'my-app-image.tar'
        IMAGE_TAG      = "1.${env.BUILD_NUMBER}.0"
    }
</code></pre>
        </div>
    </div>
</div>

<pre><code>    stages {
</code></pre>

<div class="code-accordion">
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Build Image') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Build Image') {
            steps {
                script {
                    echo "Building image with tag: ${env.IMAGE_TAG}"
                    sh "docker build -t ${env.ECR_REGISTRY}/${env.ECR_REPOSITORY}:${env.IMAGE_TAG} ."
                    sh "docker save ${env.ECR_REGISTRY}/${env.ECR_REPOSITORY}:${env.IMAGE_TAG} --output ${env.IMAGE_FILE_NAME}"
                    stash name: 'docker-image', includes: "${env.IMAGE_FILE_NAME}"
                }
            }
        }
</code></pre>
        </div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Test Image') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Test Image') {
            steps {
                script {
                    unstash 'docker-image'
                    sh "docker load --input ${env.IMAGE_FILE_NAME}"
                    sh """
                    IMAGE_NAME=${env.ECR_REGISTRY}/${env.ECR_REPOSITORY}:${env.IMAGE_TAG}
                    docker run -d --name my-app-test -p 8080:5000 \$IMAGE_NAME
                    sleep 15
                    curl --fail http://localhost:8080/ || exit 1
                    """
                }
            }
            post {
                always {
                    sh "docker stop my-app-test || true"
                    sh "docker rm my-app-test || true"
                }
            }
        }
</code></pre>
        </div>
    </div>

    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Push Image to ECR') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Push Image to ECR') {
            steps {
                script {
                    unstash 'docker-image'
                    sh "docker load --input ${env.IMAGE_FILE_NAME}"
                    withCredentials([aws(credentials: 'aws-credentials')]) {
                        sh "aws ecr get-login-password --region ${env.AWS_REGION} | docker login --username AWS --password-stdin ${env.ECR_REGISTRY}"
                        sh "docker tag ${env.ECR_REGISTRY}/${env.ECR_REPOSITORY}:${env.IMAGE_TAG} ${env.ECR_REGISTRY}/${env.ECR_REPOSITORY}:latest"
                        sh "docker push ${env.ECR_REGISTRY}/${env.ECR_REPOSITORY} --all-tags"
                    }
                }
            }
        }
    }
}
</code></pre>
        </div>
    </div>
</div>
