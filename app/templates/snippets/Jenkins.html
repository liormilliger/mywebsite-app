<a href="/Jenkinsfile-demo" class="download-link" download title="Click to download the file">
    <h3 class="downloadable-title">Jenkinsfile<i class="fas fa-download"></i></h3>
</a>

<div class="snippet-intro">
    <p>
        The most commonly used, powerful, declarative CI tool, an open-source automation server with a massive plugin ecosystem, perfect for building, deploying, and automating any CI/CD pipeline. I am using the following stages to make sure that I build a resilient and secure image, that will be versioned and pushed to my Artifact storage.
    </p>
</div>

<div class="code-accordion">
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">environment { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>    environment {
        AWS_REGION      = "us-east-1"
        ECR_REGISTRY    = "${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com"
        ECR_REPOSITORY  = "mywebsite"
        IMAGE_FILE_NAME = "my-app-image.tar"
        BRANCH_NAME     = "${env.GIT_BRANCH?.replaceAll(/[^a-zA-Z0-9]/, '-')}"
        IMAGE_TAG       = "1.${env.BUILD_NUMBER}-${BRANCH_NAME}"
    }
</code></pre>
        </div>
    </div>
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Checkout') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Checkout') {
            steps {
                checkout scm
            }
        }
</code></pre>
        </div>
    </div>
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Build Image') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Build Image') {
            steps {
                script {
                    sh """
                        echo "Building Docker image..."
                        docker build -t ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} .
                        docker save ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} -o ${IMAGE_FILE_NAME}
                    """
                    archiveArtifacts artifacts: "${IMAGE_FILE_NAME}", fingerprint: true
                }
            }
        }
</code></pre>
        </div>
    </div>
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Integration Test - Database') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Integration Test - Database') {
            when {
                expression {
                    return env.BRANCH_NAME == "database" || (env.GIT_COMMIT && sh(script: "git log -1 --pretty=%B | grep -E 'db|database' || true", returnStatus: true) == 0)
                }
            }
            steps {
                script {
                    // Use Jenkins credentials for the database
                    // This injects DB_USER and DB_PASS as environment variables
                    withCredentials([
                        [$class: 'UsernamePasswordMultiBinding', 
                         credentialsId: 'my-db-creds',
                         dbnameVariable: 'DB_NAME',
                         usernameVariable: 'DB_USER',
                         passwordVariable: 'DB_PASS']
                    ]) {
                        sh """
                            echo "Running Database Integration Tests..."
                            curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                            chmod +x /usr/local/bin/docker-compose
                            docker load -i ${IMAGE_FILE_NAME}
                            docker-compose -f docker-compose.ci.yaml -p ci up -d
                            echo "Waiting for services..."
                            sleep 15
                            docker run --rm --network=ci_default \
                                -v $(pwd)/test_db.py:/test_db.py \
                                -e POSTGRES_HOST=db \
                                -e POSTGRES_DB=${DB_NAME} \
                                -e POSTGRES_USER=${DB_USER} \
                                -e POSTGRES_PASSWORD=${DB_PASS} \
                                --entrypoint="" python:3.9-slim \
                                sh -c "pip install psycopg2-binary requests && python -u /test_db.py"
                        """
                    }
                }
            }
            post {
                always {
                    sh "docker-compose -f docker-compose.ci.yaml -p ci down || true"
                }
            }
        }
</code></pre>
        </div>
    </div>
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Integration Test - App Only') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Integration Test - App Only') {
            when {
                expression {
                    return !(env.BRANCH_NAME == "database" || (env.GIT_COMMIT && sh(script: "git log -1 --pretty=%B | grep -E 'db|database' || true", returnStatus: true) == 0))
                }
            }
            steps {
                script {
                    sh """
                        echo "Running application-only tests..."
                        echo "Application test placeholder successful!"
                    """
                }
            }
        }
</code></pre>
        </div>
    </div>
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Security Scan') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Security Scan') {
            steps {
                script {
                    sh """
                        echo "Running Gitleaks scan..."
                        docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest detect --source=/repo --no-git -v || true

                        echo "Running Trivy scan..."
                        docker run --rm -v $(pwd):/work -v /var/run/docker.sock:/var/run/docker.sock \
                            aquasec/trivy image --exit-code 1 --severity HIGH,CRITICAL \
                            ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG} || true
                    """
                }
            }
        }
</code></pre>
        </div>
    </div>
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Push to ECR') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Push to ECR') {
            when {
                expression { return !sh(script: "git log -1 --pretty=%B | grep 'skip' || true", returnStatus: true) == 0 }
            }
            steps {
                script {
                    withCredentials([
                        [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-jenkins-creds']
                    ]) {
                        sh """
                            echo "Logging into Amazon ECR..."
                            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                            docker load -i ${IMAGE_FILE_NAME}
                            docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
                        """
                    }
                }
            }
        }
</code></pre>
        </div>
    </div>
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">stage('Update Kubernetes Manifest Repo') { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>        stage('Update Kubernetes Manifest Repo') {
            steps {
                script {
                    sshagent(['github-pat']) {
                        sh """
                            echo "Cloning Kubernetes manifest repo..."
                            git clone --branch ${BRANCH_NAME} https://github.com/liormilliger/mywebsite-k8s.git
                            cd mywebsite-k8s
                            wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
                            chmod +x /usr/bin/yq
                            yq eval '.image.tag = "${IMAGE_TAG}"' -i my-app-chart/values.yaml
                            git config user.name "Jenkins"
                            git config user.email "jenkins@local"
                            git commit -am "Update image tag for mywebsite to ${IMAGE_TAG}" || echo "No changes"
                            git push
                        """
                    }
                }
            }
        }
</code></pre>
        </div>
    </div>
    <div class="accordion-item">
        <button class="accordion-header">
            <span class="header-title">post { ... }</span>
            <span class="accordion-icon">+</span>
        </button>
        <div class="accordion-content">
<pre><code>    post {
        always {
            echo "Pipeline completed for branch: ${BRANCH_NAME}"
        }
    }
}
</code></pre>
        </div>
    </div>
</div>
