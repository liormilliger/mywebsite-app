<h2>Bash: Automating SSL Certificates with Docker Compose and Certbot</h2>
<p>
    This Bash script automates the entire process of obtaining and installing a free SSL/TLS certificate from Let's Encrypt for a web server running inside Docker. It is designed to work with a Docker Compose setup that includes an Nginx web server and a Certbot container.
</p>
<ul>
    <li><strong>Automation:</strong> The script handles everything from creating temporary certificates to allow Nginx to start, to requesting the real certificate from Let's Encrypt, and finally reloading Nginx to apply it.</li>
    <li><strong>Docker Integration:</strong> It seamlessly manages the Docker containers, starting, stopping, and executing commands within them as needed for the certification process.</li>
    <li><strong>Best Practices:</strong> The script downloads recommended TLS security parameters and automates the certificate renewal process setup, ensuring a secure and up-to-date configuration.</li>
</ul>

<h4>init-letsencrypt.sh</h4>
<div class="code-container-bash">
<pre><code><span class="bash-comment">#!/bin/bash</span>

<span class="bash-comment"># Make sure to replace these with your domain and email</span>
<span class="bash-variable">domains</span>=(<span class="bash-string">your-domain.com</span>)
<span class="bash-variable">email</span>=<span class="bash-string">"your-email@example.com"</span> <span class="bash-comment"># Add a valid email address</span>

<span class="bash-variable">data_path</span>=<span class="bash-string">"./data/certbot"</span>
<span class="bash-variable">rsa_key_size</span>=4096
<span class="bash-variable">staging</span>=0 <span class="bash-comment"># Set to 1 for testing with staging servers</span>

<span class="bash-keyword">if</span> [ -d <span class="bash-string">"<span class="bash-variable">$data_path</span>"</span> ]; <span class="bash-keyword">then</span>
  <span class="bash-command">read</span> -p <span class="bash-string">"Existing data found for <span class="bash-variable">$domains</span>. Continue and replace existing certificate? (y/N) "</span> decision
  <span class="bash-keyword">if</span> [ <span class="bash-string">"<span class="bash-variable">$decision</span>"</span> != <span class="bash-string">"Y"</span> ] && [ <span class="bash-string">"<span class="bash-variable">$decision</span>"</span> != <span class="bash-string">"y"</span> ]; <span class="bash-keyword">then</span>
    <span class="bash-keyword">exit</span>
  <span class="bash-keyword">fi</span>
<span class="bash-keyword">fi</span>

<span class="bash-keyword">if</span> [ ! -e <span class="bash-string">"<span class="bash-variable">$data_path</span>/conf/options-ssl-nginx.conf"</span> ] || [ ! -e <span class="bash-string">"<span class="bash-variable">$data_path</span>/conf/ssl-dhparams.pem"</span> ]; <span class="bash-keyword">then</span>
  <span class="bash-command">echo</span> <span class="bash-string">"### Downloading recommended TLS parameters ..."</span>
  <span class="bash-command">mkdir</span> -p <span class="bash-string">"<span class="bash-variable">$data_path</span>/conf"</span>
  <span class="bash-command">curl</span> -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf > <span class="bash-string">"<span class="bash-variable">$data_path</span>/conf/options-ssl-nginx.conf"</span>
  <span class="bash-command">curl</span> -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem > <span class="bash-string">"<span class="bash-variable">$data_path</span>/conf/ssl-dhparams.pem"</span>
  <span class="bash-command">echo</span>
<span class="bash-keyword">fi</span>

<span class="bash-command">echo</span> <span class="bash-string">"### Creating dummy certificate for <span class="bash-variable">$domains</span> ..."</span>
<span class="bash-variable">path</span>=<span class="bash-string">"/etc/letsencrypt/live/<span class="bash-variable">$domains</span>"</span>
<span class="bash-command">mkdir</span> -p <span class="bash-string">"<span class="bash-variable">$data_path</span>/conf/live/<span class="bash-variable">$domains</span>"</span>
<span class="bash-command">docker-compose</span> run --rm --entrypoint "\
  openssl req -x509 -nodes -newkey rsa:<span class="bash-variable">$rsa_key_size</span> -days 1\
    -keyout '<span class="bash-variable">$path</span>/privkey.pem' \
    -out '<span class="bash-variable">$path</span>/fullchain.pem' \
    -subj '/CN=localhost'" certbot
<span class="bash-command">echo</span>

<span class="bash-command">echo</span> <span class="bash-string">"### Starting nginx ..."</span>
<span class="bash-command">docker-compose</span> up --force-recreate -d nginx
<span class="bash-command">echo</span>

<span class="bash-command">echo</span> <span class="bash-string">"### Deleting dummy certificate for <span class="bash-variable">$domains</span> ..."</span>
<span class="bash-command">docker-compose</span> run --rm --entrypoint "\
  rm -Rf /etc/letsencrypt/live/<span class="bash-variable">$domains</span> && \
  rm -Rf /etc/letsencrypt/archive/<span class="bash-variable">$domains</span> && \
  rm -Rf /etc/letsencrypt/renewal/<span class="bash-variable">$domains</span>.conf" certbot
<span class="bash-command">echo</span>

<span class="bash-command">echo</span> <span class="bash-string">"### Requesting Let's Encrypt certificate for <span class="bash-variable">$domains</span> ..."</span>
<span class="bash-variable">domain_args</span>=<span class="bash-string">""</span>
<span class="bash-keyword">for</span> domain <span class="bash-keyword">in</span> <span class="bash-string">"<span class="bash-variable">${domains[@]}</span>"</span>; <span class="bash-keyword">do</span>
  <span class="bash-variable">domain_args</span>=<span class="bash-string">"<span class="bash-variable">$domain_args</span> -d <span class="bash-variable">$domain</span>"</span>
<span class="bash-keyword">done</span>

<span class="bash-variable">email_arg</span>=<span class="bash-string">"--email <span class="bash-variable">$email</span>"</span>
<span class="bash-keyword">case</span> <span class="bash-string">"<span class="bash-variable">$email</span>"</span> <span class="bash-keyword">in</span>
  <span class="bash-string">""</span>) <span class="bash-variable">email_arg</span>=<span class="bash-string">"--register-unsafely-without-email"</span> ;;
<span class="bash-keyword">esac</span>

<span class="bash-keyword">if</span> [ <span class="bash-variable">$staging</span> != <span class="bash-string">"0"</span> ]; <span class="bash-keyword">then</span> <span class="bash-variable">staging_arg</span>=<span class="bash-string">"--staging"</span>; <span class="bash-keyword">fi</span>

<span class="bash-command">docker-compose</span> run --rm --entrypoint "\
  certbot certonly --webroot -w /var/www/certbot \
    <span class="bash-variable">$staging_arg</span> \
    <span class="bash-variable">$email_arg</span> \
    <span class="bash-variable">$domain_args</span> \
    --rsa-key-size <span class="bash-variable">$rsa_key_size</span> \
    --agree-tos \
    --force-renewal" certbot
<span class="bash-command">echo</span>

<span class="bash-command">echo</span> <span class="bash-string">"### Reloading nginx ..."</span>
<span class="bash-command">docker-compose</span> exec nginx nginx -s reload

<span class="bash-command">echo</span> <span class="bash-string">"### Your site is now running with HTTPS! ###"</span>
</code></pre>
</div>

<h4>Script Breakdown</h4>
<p>
    This script is executed in several distinct stages to ensure a smooth and automated setup:
</p>
<ol>
    <li>
        <strong>Configuration:</strong> At the top, you define the domain(s) you want to secure and a contact email address. This makes the script easy to adapt for different projects.
    </li>
    <li>
        <strong>Download TLS Parameters:</strong> The script checks if secure TLS parameters from Certbot's official repository exist. If not, it downloads them. These files provide strong, up-to-date SSL/TLS settings for Nginx.
    </li>
    <li>
        <strong>Create a Dummy Certificate:</strong> Nginx won't start if it's configured for HTTPS but can't find an SSL certificate. To solve this chicken-and-egg problem, the script generates a temporary, self-signed "dummy" certificate.
    </li>
    <li>
        <strong>Start Nginx:</strong> With the dummy certificate in place, the script starts the Nginx container. Nginx can now run and is ready to serve the validation files that Let's Encrypt needs to see.
    </li>
    <li>
        <strong>Request the Real Certificate:</strong> The script then deletes the dummy certificate and runs the Certbot container. Certbot communicates with Let's Encrypt's servers, which perform an HTTP-01 challenge to verify that you control the domain. Once verified, Let's Encrypt issues a real certificate.
    </li>
    <li>
        <strong>Reload Nginx:</strong> Finally, the script sends a reload command to the running Nginx container. This causes Nginx to gracefully pick up the new, official Let's Encrypt certificate without any downtime, completing the switch to HTTPS.
    </li>
</ol>