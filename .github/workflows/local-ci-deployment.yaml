name: Deploy to Production (In-Place)

on:
  workflow_dispatch:
  push:
    paths:
      - 'app/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Update Code & Restart
        run: |
          # --- CONFIGURATION ---
          PROD_DIR="/mywebsite"

          echo "--- Checking Directory ---"
          if [ ! -d "$PROD_DIR" ]; then
            echo "Error: Directory $PROD_DIR does not exist."
            exit 1
          fi

          echo "--- Fixing Git Permissions ---"
          sudo git config --global --add safe.directory $PROD_DIR

          echo "--- Pulling Latest Code ---"
          sudo git -C $PROD_DIR pull origin main

          echo "--- Building App Image ---"
          sudo docker compose --project-directory $PROD_DIR build app

          echo "--- Recreating App Container ---"
          sudo docker compose --project-directory $PROD_DIR up -d --no-deps app

      - name: Verify Health
        run: |
          PROD_DIR="/root/mywebsite"
          
          echo "--- Internal Docker Check ---"
          if [ -z "$(sudo docker compose --project-directory $PROD_DIR ps -q app)" ]; then
            echo "Error: App container is not running!"
            exit 1
          fi

          echo "--- External URL Check ---"
          sleep 5
          curl -f -I -L https://liormilliger.com