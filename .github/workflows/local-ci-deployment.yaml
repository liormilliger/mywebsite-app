name: Deploy to Production (In-Place)

on:
  workflow_dispatch:
  push:
    paths:
      - 'app/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Update Code & Restart
        run: |
          # --- CONFIGURATION ---
          PROD_DIR="/root/mywebsite-app"

          echo "--- Checking Directory (with sudo) ---"
          # We must use 'sudo test -d' because 'ubuntu' cannot look inside '/root'
          if ! sudo test -d "$PROD_DIR"; then
            echo "Error: Directory $PROD_DIR does not exist or is not accessible."
            exit 1
          fi

          echo "--- Fixing Git Permissions ---"
          # Allow operations on the root-owned directory
          sudo git config --global --add safe.directory "$PROD_DIR"

          echo "--- Pulling Latest Code ---"
          # -C runs git inside that folder without needing to 'cd'
          sudo git -C "$PROD_DIR" pull origin main

          echo "--- Building App Image ---"
          # --project-directory ensures Docker finds the .env file in /root/mywebsite-app
          sudo docker compose --project-directory "$PROD_DIR" build app

          echo "--- Recreating App Container ---"
          # Recreates only the app container, keeps DB/Nginx alive
          sudo docker compose --project-directory "$PROD_DIR" up -d --no-deps app

      - name: Verify Health
        run: |
          PROD_DIR="/root/mywebsite-app"
          
          echo "--- Internal Docker Check ---"
          if [ -z "$(sudo docker compose --project-directory "$PROD_DIR" ps -q app)" ]; then
            echo "Error: App container is not running!"
            exit 1
          fi

          echo "--- External URL Check ---"
          sleep 5
          curl -f -I -L https://liormilliger.com