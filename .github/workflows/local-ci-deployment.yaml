name: Deploy App to EC2

on:
  push:
    paths:
      - "app/**"
  workflow_dispatch:
  
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create SSH key file
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

      - name: Add EC2 host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

          set -e

          cd ~/mywebsite-iac

          echo ">>> Pulling latest repo changes"
          git pull origin main

          echo ">>> Rebuilding the app image"
          docker-compose build app

          echo ">>> Restarting only the app container"
          docker-compose up -d app

          echo ">>> Checking running containers"
          docker ps

          echo ">>> Waiting 5 seconds for app to start"
          sleep 5

          echo ">>> Doing curl health check"
          curl -I https://liormilliger.com || exit 1

          echo ">>> Deployment completed successfully"
          EOF
