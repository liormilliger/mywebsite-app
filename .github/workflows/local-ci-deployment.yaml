name: Deploy to Production (In-Place)

on:
  workflow_dispatch:
  push:
    paths:
      - 'app/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Update Code & Restart
        run: |
          # --- CONFIGURATION ---
          # 1. Corrected Path based on your comment
          PROD_DIR="/root/mywebsite-app"

          echo "--- Checking Directory (with sudo) ---"
          if ! sudo test -d "$PROD_DIR"; then
            echo "Error: Directory $PROD_DIR does not exist."
            exit 1
          fi

          echo "--- Fixing Git Permissions ---"
          sudo git config --global --add safe.directory "$PROD_DIR"

          echo "--- Force Updating Code ---"
          # 2. We use 'fetch' + 'reset --hard' to overwrite local changes (fixes the JPG conflict)
          sudo git -C "$PROD_DIR" fetch origin main
          sudo git -C "$PROD_DIR" reset --hard origin/main

          echo "--- Building App Image ---"
          # Build using the .env file located inside that folder
          sudo docker compose --project-directory "$PROD_DIR" build app

          echo "--- Removing Old Container ---"
          # -f stops and removes it. || true prevents failure if it's already gone.
          sudo docker rm -f mywebsite-app || true

          echo "--- Starting New Container ---"
          sudo docker compose --project-directory "$PROD_DIR" up -d --no-deps app

      - name: Verify Health
        run: |
          PROD_DIR="/root/mywebsite-app"
          
          echo "--- Internal Docker Check ---"
          if [ -z "$(sudo docker compose --project-directory "$PROD_DIR" ps -q app)" ]; then
            echo "Error: App container is not running!"
            exit 1
          fi

          echo "--- External URL Check ---"
          sleep 5
          curl -f -I -L https://liormilliger.com