---
- name: Deploy App to EC2 (Local)
  hosts: localhost
  connection: local
  become: true        # <--- Runs ALL tasks as root (sudo)

  vars:
    # UPDATED: Pointing to the actual root directory you mentioned
    project_root: "/root/mywebsite"
    repo_url: "https://github.com/liormilliger/mywebsite-app.git"

  tasks:
    - name: Ensure project directory exists
      file:
        path: "{{ project_root }}"
        state: directory
        owner: root   # Explicitly set owner to root
        group: root
        mode: '0755'

    - name: Update Repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ project_root }}"
        version: main
        force: yes
        # safe_directory is needed when git is run by a different user than the owner
        # We configure git globally for this run to trust this directory
      environment:
        GIT_OPTS: "--config safe.directory={{ project_root }}"

    - name: Trust the git directory (Safe Directory Fix)
      # Git creates a safety error if you try to pull a folder owned by root 
      # while running via sudo. This fixes it.
      command: git config --global --add safe.directory "{{ project_root }}"

    - name: Build the App Image
      command: docker compose build app
      args:
        chdir: "{{ project_root }}"

    - name: Smart Restart (App Only)
      command: docker compose up -d --no-deps app
      args:
        chdir: "{{ project_root }}"

    - name: Wait for App to initialize
      wait_for:
        timeout: 10

    - name: Verify App Container is Running
      shell: |
        if [ -z "$(docker compose ps -q app)" ]; then exit 1; fi
      args:
        chdir: "{{ project_root }}"

    - name: HTTP Health Check
      uri:
        url: "https://liormilliger.com"
        method: GET
        status_code: 200
        follow_redirects: all